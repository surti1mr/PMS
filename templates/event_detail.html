{% extends "base.html" %}

{% block title %}Event Details - {{ event.event_name }}{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Top Header with Hamburger and PMS -->
    <div class="top-header">
        <button class="hamburger-btn" onclick="toggleSidebar()">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>
        <h1 class="app-title">Open-Mic Participation Management System</h1>
        {% if current_user %}
        <div class="user-greeting">Hi, {{ current_user.first_name }}</div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    {% from 'sidebar_macros.html' import render_sidebar %}
    {{ render_sidebar('events') }}

    <!-- Main Content -->
    <div class="main-content">
        <div class="content-header" style="text-align:center;">
            <h1 style="margin:0;">{{ event.event_name }}</h1>
            {% if event.event_date %}
            <p style="margin:6px 0 0 0;">{{ event.event_date.strftime('%B %d, %Y at %I:%M %p') }}</p>
            {% endif %}
        </div>

        <div class="content-body">
            <div style="width:100%;max-width:800px;margin:0 auto;">
                <div class="event-card" style="padding:24px;">
                    <div style="display:grid;grid-template-columns:1fr 2fr;gap:12px;row-gap:12px;align-items:center;">
                        <div><strong>Location</strong></div>
                        <div class="event-location">{{ event.location or 'Location TBD' }}</div>

                        {% if event.total_spots %}
                        <div><strong>Total Spots</strong></div>
                        <div class="event-spots">{{ event.total_spots }}</div>
                        {% endif %}

                        {% if event.registration_deadline %}
                        <div><strong>Registration Deadline</strong></div>
                        <div class="event-deadline">{{ event.registration_deadline.strftime('%B %d, %Y at %I:%M %p') }}</div>
                        {% endif %}
                    </div>

                    <div style="margin-top:16px;">
                        <h3 style="margin:0 0 8px 0;">Description</h3>
                        {% if event.event_description %}
                        <p class="event-description">{{ event.event_description }}</p>
                        {% else %}
                        <p class="event-description"><em>No description provided.</em></p>
                        {% endif %}
                    </div>

                    <div style="margin-top:20px;display:flex;align-items:center;flex-wrap:wrap;justify-content:space-between;gap:12px;">
                        <div style="display:flex;gap:12px;align-items:center;">
                            <a class="btn-primary" href="{{ url_for('events') }}">Back to Events</a>
                            {% if user_type == 'event_manager' or user_type == 'admin' %}
                            <a href="{{ url_for('edit_event', event_id=event.event_id) }}" class="btn-secondary" style="text-decoration:none;display:inline-flex;align-items:center;gap:6px;">
                                <span>✏️</span>
                                <span>Edit Event</span>
                            </a>
                            {% endif %}
                        </div>
                        {% if session.user_type|lower == 'participant' %}
                        <div style="margin-left:auto;">
                            <a href="{{ url_for('register_event', event_id=event.event_id) }}" class="btn-register" style="text-decoration:none;display:inline-block;width:auto;min-width:140px;text-align:center;">Register</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Registered Participants Table (for Event Managers and Admins) -->
                {% if user_type == 'event_manager' or user_type == 'admin' %}
                <div class="event-card" style="padding:32px;margin-top:24px;">
                    <h2 style="color:#2d3748;margin-bottom:24px;font-size:24px;border-bottom:2px solid rgba(102, 126, 234, 0.2);padding-bottom:16px;">
                        Registered Participants
                        {% if registrations and registrations|length > 0 %}
                        ({{ registrations|length }})
                        {% endif %}
                    </h2>
                    
                    {% if registrations and registrations|length > 0 %}
                    <div style="overflow-x: auto; width: 100%; margin: 0; -webkit-overflow-scrolling: touch;">
                        <table style="width: 100%; min-width: 1000px; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin: 0 auto; table-layout: auto;">
                            <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <tr>
                                    <th style="padding: 18px 24px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap; width: 150px;">Name</th>
                                    <th style="padding: 18px 24px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap; width: 250px;">Email</th>
                                    <!-- <th>Phone</th> -->
                                    <th style="padding: 18px 24px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap; width: 140px;">Registration Date</th>
                                    <th style="padding: 18px 24px; text-align: center; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap; width: 130px;">Status</th>
                                    <th style="padding: 18px 24px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap; width: 180px;">Additional Info</th>
                                    <th style="padding: 18px 24px; text-align: center; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.8px; white-space: nowrap; width: 150px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for registration in registrations %}
                                <tr style="border-bottom: 1px solid #f0f4f8;">
                                    <td style="padding: 18px 24px; font-size: 15px; color: #1a202c; vertical-align: middle; font-weight: 600;">
                                        {% if registration.participant %}
                                        <strong>{{ registration.participant.first_name }} {{ registration.participant.last_name }}</strong>
                                        {% else %}
                                        <strong>N/A</strong>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 18px 24px; font-size: 15px; color: #667eea; vertical-align: middle; word-break: break-word; overflow-wrap: anywhere;">
                                        {% if registration.participant %}
                                        {{ registration.participant.email }}
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <!-- <td>
                                        {% if registration.participant %}
                                        {{ registration.participant.phone_number or '—' }}
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td> -->
                                    <td style="padding: 18px 24px; font-size: 15px; color: #4a5568; vertical-align: middle; white-space: nowrap;">
                                        {% if registration.registered_at %}
                                        {{ registration.registered_at.strftime('%m/%d/%Y') }}
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td style="padding: 18px 24px; font-size: 15px; color: #2d3748; vertical-align: middle; text-align: center;">
                                        {% if registration.registration_status %}
                                            {% set status_name = registration.registration_status.status_name|lower %}
                                            {% if 'approved' in status_name or 'accept' in status_name %}
                                                <span class="status-badge active">{{ registration.registration_status.status_name }}</span>
                                            {% elif 'rejected' in status_name or 'reject' in status_name or 'declined' in status_name %}
                                                <span class="status-badge inactive">{{ registration.registration_status.status_name }}</span>
                                            {% elif 'cancel' in status_name %}
                                                <span class="status-badge inactive">{{ registration.registration_status.status_name }}</span>
                                            {% else %}
                                                <span class="status-badge" style="background:rgba(237,137,54,0.1);color:#ed8936;border:1px solid rgba(237,137,54,0.3);">{{ registration.registration_status.status_name }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="status-badge" style="background:rgba(237,137,54,0.1);color:#ed8936;border:1px solid rgba(237,137,54,0.3);">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 18px 24px; font-size: 15px; color: #2d3748; vertical-align: middle;">
                                        {% if registration.additional_info %}
                                        <div style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="{{ registration.additional_info }}">
                                            {{ registration.additional_info }}
                                        </div>
                                        {% else %}
                                        —
                                        {% endif %}
                                    </td>
                                    <td style="padding: 18px 24px; font-size: 15px; color: #2d3748; vertical-align: middle; text-align: center;">
                                        <div style="display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: nowrap;">
                                            {% set current_status_name = '' %}
                                            {% if registration.registration_status %}
                                                {% set current_status_name = registration.registration_status.status_name|lower %}
                                            {% endif %}
                                            {% set is_current_reg_approved = 'approved' in current_status_name or 'accept' in current_status_name or 'confirm' in current_status_name %}
                                            {% set event_is_full = event.total_spots and approved_count >= event.total_spots %}
                                            <select style="background: transparent; border: 2px solid #e2e8f0; border-radius: 8px; padding: 6px 12px; font-size: 14px; cursor: pointer; transition: all 0.3s ease; color: #4a5568; font-weight: 500;" 
                                                    data-registration-id="{{ registration.registration_id }}">
                                                {% for status in registration_statuses %}
                                                {% set status_name_lower = status.status_name|lower %}
                                                {% set is_approved_status = 'approved' in status_name_lower or 'accept' in status_name_lower or 'confirm' in status_name_lower %}
                                                {% set is_current_status = registration.registration_status_id == status.registration_status_id %}
                                                {% set should_disable = is_approved_status and event_is_full and not is_current_reg_approved and not is_current_status %}
                                                <option value="{{ status.registration_status_id }}" 
                                                        {% if is_current_status %}selected{% endif %}
                                                        {% if should_disable %}disabled{% endif %}>
                                                    {{ status.status_name }}{% if should_disable %} (Event Full){% endif %}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div style="text-align:center;padding:40px;color:#718096;">
                        <p style="font-size:16px;margin:0;">No participants have registered for this event yet.</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const hamburgerBtn = document.querySelector('.hamburger-btn');
    sidebar.classList.toggle('sidebar-open');
    hamburgerBtn.classList.toggle('hamburger-active');
    const isOpen = sidebar.classList.contains('sidebar-open');
    sessionStorage.setItem('sidebarOpen', isOpen);
}

function closeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const hamburgerBtn = document.querySelector('.hamburger-btn');
    sidebar.classList.remove('sidebar-open');
    hamburgerBtn.classList.remove('hamburger-active');
    sessionStorage.setItem('sidebarOpen', false);
}

// Restore sidebar state on page load and initialize status handlers
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const hamburgerBtn = document.querySelector('.hamburger-btn');
    const sidebarOpen = sessionStorage.getItem('sidebarOpen');
    if (sidebarOpen === 'true') {
        sidebar.classList.add('sidebar-open');
        hamburgerBtn.classList.add('hamburger-active');
    }
    
    // Initialize status update handlers
    const statusSelects = document.querySelectorAll('select[data-registration-id]');
    statusSelects.forEach(select => {
        select.addEventListener('change', function() {
            const registrationId = this.getAttribute('data-registration-id');
            const statusId = this.value;
            updateRegistrationStatus(registrationId, statusId, this);
        });
        
        // Add hover effects for select dropdown
        select.addEventListener('mouseenter', function() {
            this.style.borderColor = '#667eea';
            this.style.background = 'rgba(102, 126, 234, 0.05)';
        });
        
        select.addEventListener('mouseleave', function() {
            this.style.borderColor = '#e2e8f0';
            this.style.background = 'transparent';
        });
        
        select.addEventListener('focus', function() {
            this.style.outline = 'none';
            this.style.borderColor = '#667eea';
            this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
        });
        
        select.addEventListener('blur', function() {
            this.style.boxShadow = 'none';
            this.style.borderColor = '#e2e8f0';
        });
    });
});

// Close sidebar when clicking outside (but not on menu items)
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const hamburgerBtn = document.querySelector('.hamburger-btn');
    const navLinks = document.querySelectorAll('.nav-link');
    let isNavLink = false;
    navLinks.forEach(link => { if (link.contains(event.target)) { isNavLink = true; } });
    if (!sidebar.contains(event.target) && !hamburgerBtn.contains(event.target) && !isNavLink) {
        sidebar.classList.remove('sidebar-open');
        hamburgerBtn.classList.remove('hamburger-active');
        sessionStorage.setItem('sidebarOpen', false);
    }
});

function registerForEvent(eventId) {
    if (confirm('Are you sure you want to register for this event?')) {
        fetch(`/api/register/${eventId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ additional_info: 'Registered via web interface' })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Registration successful!');
                location.reload();
            } else {
                alert('Registration failed: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Registration failed. Please try again.');
        });
    }
}

function updateRegistrationStatus(registrationId, statusId, selectElement) {
    if (confirm('Are you sure you want to update the registration status?')) {
        fetch(`/api/registration/${registrationId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ registration_status_id: parseInt(statusId) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Registration status updated successfully!');
                location.reload();
            } else {
                alert('Failed to update status: ' + (data.error || 'Unknown error'));
                location.reload(); // Reload to reset dropdown
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update registration status. Please try again.');
            location.reload(); // Reload to reset dropdown
        });
    } else {
        // Reset dropdown to original value if user cancels
        location.reload();
    }
}
</script>
{% endblock %}


